<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      #ui-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #0b0b0b; display: flex; flex-direction: column;
        justify-content: center; align-items: center; z-index: 9999; color: white;
        font-family: sans-serif;
      }
      #start-button {
        padding: 20px 40px; font-size: 22px; font-weight: bold;
        background: #00e676; color: black; border: none; 
        border-radius: 50px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,230,118,0.4);
      }
      .loading-text { margin-bottom: 20px; font-size: 18px; }
    </style>
  </head>
  <body>

    <div id="ui-overlay">
      <div class="loading-text">Dymind DF-55 AR</div>
      <button id="start-button">เปิดกล้องและเริ่มรับฟัง</button>
    </div>

    <audio id="bgMusic" src="./sound.mp3" preload="auto" playsinline></audio>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: no; uiError: no; uiScanning: no;" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights: true" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="medicalModel" src="./model.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-gltf-model src="#medicalModel" 
                      rotation="0 0 0" 
                      position="0 0 0" 
                      scale="0.36 0.472 0.442">
        </a-gltf-model>
      </a-entity>
    </a-scene>

    <script>
      const startButton = document.querySelector("#start-button");
      const overlay = document.querySelector("#ui-overlay");
      const audio = document.querySelector("#bgMusic");
      const sceneEl = document.querySelector("a-scene");

      startButton.addEventListener('click', () => {
        // 1. ซ่อนหน้า Overlay 
        overlay.style.display = "none";
        
        // 2. ปลดล็อกเสียงสำหรับ iOS (ต้องสั่ง play และ pause ทันทีเพื่อจองสิทธิ์)
        audio.play();
        
        // 3. เริ่มระบบ AR (กล้องจะเปิด)
        sceneEl.systems["mindar-image-system"].start();
        
        console.log("AR System Started for iOS/Android");
      });

      // ดักฟังเหตุการณ์เมื่อเจอ Target (การ์ด) เพื่อให้เสียงเริ่มเล่นจากจุดเริ่มต้น
      const targetEntity = document.querySelector('[mindar-image-target]');
      targetEntity.addEventListener("targetFound", event => {
        console.log("Target Found: Playing Audio");
        audio.currentTime = 0; // เริ่มเสียงใหม่ทุกครั้งที่เจอการ์ด
        audio.play();
      });

      // หยุดเสียงเมื่อหาการ์ดไม่เจอ (ตัวเลือกเสริม)
      targetEntity.addEventListener("targetLost", event => {
        audio.pause();
      });
    </script>
  </body>
</html>
